// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

model User{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    imageUrl   String?
    firstName  String?
    lastName   String?
    EmailAddress      String   @unique
    userToProjects UserToProject[]
    credits    Int @default(150)
    QuestionsAsked Question[]
    
    // Tier 1: Team Collaboration
    chatMessages ChatMessage[]
    chatParticipants ChatParticipant[]
    mentions UserMention[]
    reactions MessageReaction[]
    annotations CodeAnnotation[]
    annotationReplies AnnotationReply[]
    
    // Tier 1: Analytics
    developerMetrics DeveloperMetric[]
    
    // Tier 1: Meetings Enhanced
    assignedActionItems ActionItem[] @relation("AssignedActionItems")
}

model Project{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    name String
    repoUrl String
    gitHubToken String?
    deletedAt DateTime?
    userToProjects UserToProject[]

    Commit Commit[]
    sourceCodeEmbedding SourceCodeEmbedding[]
    SavedQuestion Question[]
    Meetings Meeting[]
    
    // Tier 1: Code Review & Analysis
    codeReviews CodeReview[]
    
    // Tier 1: Team Collaboration
    teamChats TeamChat[]
    codeAnnotations CodeAnnotation[]
    
    // Tier 1: Analytics
    developerMetrics DeveloperMetric[]
    teamMetrics TeamMetric[]
    codeHotspots CodeHotspot[]
    
    // Tier 1: Documentation
    documentation Documentation[]
    apiEndpoints APIEndpoint[]
    architectureDiagrams ArchitectureDiagram[]
}

model UserToProject{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    userId String
    projectId String
    user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    @@unique([userId, projectId])
}

model Commit{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    commitMessage String
    commitHash String   @unique
    commitAuthorName String
    commitAuthorAvatar String
    commitDate DateTime
    summary String

    projectId  String
    project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Question{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt


    question String
    answer String

    filesRefrences Json?

    userId String
    user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Meeting{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    meetingUrl String
    name String
    status MeetingStatus @default(PROCESSING)

    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    issues Issue[]
    
    // Tier 1: Enhanced Meeting Features
    actionItems ActionItem[]
}

enum MeetingStatus{
    PROCESSING
    COMPLETED
    
}

model Issue{
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    start String
    end String
    gist String
    headline String
    summary String
    meetingId String
    meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
}

model SourceCodeEmbedding{
    id         String   @id @default(cuid())

    summaryEmbedding Unsupported("Vector(768)")?
    sourceCode String
    fileName String
    summary String
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// ============================================
// TIER 1: AI-POWERED CODE REVIEW & ANALYSIS
// ============================================

model CodeReview{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    prNumber Int?
    prTitle String?
    prUrl String?
    branch String
    commitHash String
    
    // AI Analysis Results
    overallScore Int // 0-100
    securityScore Int // 0-100
    performanceScore Int // 0-100
    maintainabilityScore Int // 0-100
    
    status ReviewStatus @default(PENDING)
    
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    findings CodeReviewFinding[]
    suggestions CodeReviewSuggestion[]
}

model CodeReviewFinding{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    
    severity FindingSeverity
    category FindingCategory
    title String
    description String @db.Text
    filePath String
    lineNumber Int?
    codeSnippet String? @db.Text
    recommendation String @db.Text
    
    cveId String? // If it's a security vulnerability
    estimatedImpact String? // e.g., "High - Potential SQL Injection"
    
    reviewId String
    review CodeReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
}

model CodeReviewSuggestion{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    
    title String
    description String @db.Text
    filePath String
    lineNumber Int?
    originalCode String? @db.Text
    suggestedCode String @db.Text
    reasoning String @db.Text
    
    applied Boolean @default(false)
    appliedAt DateTime?
    
    reviewId String
    review CodeReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
}

enum ReviewStatus{
    PENDING
    IN_PROGRESS
    COMPLETED
    FAILED
}

enum FindingSeverity{
    CRITICAL
    HIGH
    MEDIUM
    LOW
    INFO
}

enum FindingCategory{
    SECURITY
    PERFORMANCE
    BUG
    CODE_SMELL
    BEST_PRACTICE
    DOCUMENTATION
    TESTING
    ACCESSIBILITY
}

// ============================================
// TIER 1: TEAM COLLABORATION SUITE
// ============================================

model TeamChat{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    messages ChatMessage[]
    participants ChatParticipant[]
}

model ChatMessage{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    
    content String @db.Text
    messageType MessageType @default(TEXT)
    
    // Code context
    filePath String?
    lineNumber Int?
    codeSnippet String? @db.Text
    commitHash String?
    
    // AI context injection
    aiContext String? @db.Text
    
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    chatId String
    chat TeamChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
    
    mentions UserMention[]
    reactions MessageReaction[]
    threadMessages ChatMessage[] @relation("MessageThread")
    parentMessageId String?
    parentMessage ChatMessage? @relation("MessageThread", fields: [parentMessageId], references: [id], onDelete: Cascade)
}

model ChatParticipant{
    id         String   @id @default(cuid())
    joinedAt   DateTime @default(now())
    lastReadAt DateTime?
    
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    chatId String
    chat TeamChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
    
    @@unique([userId, chatId])
}

model UserMention{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    read Boolean @default(false)
    
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    messageId String
    message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model MessageReaction{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    
    emoji String
    
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    messageId String
    message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
    
    @@unique([userId, messageId, emoji])
}

model CodeAnnotation{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    
    filePath String
    lineStart Int
    lineEnd Int
    content String @db.Text
    resolved Boolean @default(false)
    
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    replies AnnotationReply[]
}

model AnnotationReply{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    
    content String @db.Text
    
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    annotationId String
    annotation CodeAnnotation @relation(fields: [annotationId], references: [id], onDelete: Cascade)
}

enum MessageType{
    TEXT
    CODE
    FILE
    SYSTEM
}

// ============================================
// TIER 1: ADVANCED ANALYTICS DASHBOARD
// ============================================

model DeveloperMetric{
    id         String   @id @default(cuid())
    date       DateTime @db.Date
    
    // Productivity metrics
    commitsCount Int @default(0)
    linesAdded Int @default(0)
    linesDeleted Int @default(0)
    prsCreated Int @default(0)
    prsReviewed Int @default(0)
    issuesClosed Int @default(0)
    
    // Code quality metrics
    bugIntroduced Int @default(0)
    codeChurn Int @default(0) // Lines changed that were recently changed
    averageReviewTime Int @default(0) // in minutes
    
    // Activity metrics
    activeHours Float @default(0)
    focusTimeHours Float @default(0)
    meetingHours Float @default(0)
    
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    @@unique([userId, projectId, date])
}

model TeamMetric{
    id         String   @id @default(cuid())
    date       DateTime @db.Date
    
    // Team velocity
    totalCommits Int @default(0)
    totalPRs Int @default(0)
    averagePRSize Int @default(0)
    deploymentFrequency Int @default(0)
    
    // Quality metrics
    bugRate Float @default(0) // bugs per 1000 lines
    technicalDebtScore Int @default(0) // 0-100
    codeReviewCoverage Float @default(0) // percentage
    testCoverage Float @default(0) // percentage
    
    // Performance metrics
    mttr Int @default(0) // Mean Time To Recovery in minutes
    leadTime Int @default(0) // Time from commit to deploy in minutes
    changeFailureRate Float @default(0) // percentage
    
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    @@unique([projectId, date])
}

model CodeHotspot{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    
    filePath String
    changeFrequency Int // How often this file changes
    bugCount Int // Bugs found in this file
    complexity Int // Cyclomatic complexity
    riskScore Int // 0-100, calculated risk
    
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    @@unique([projectId, filePath])
}

// ============================================
// TIER 1: SMART DOCUMENTATION GENERATOR
// ============================================

model Documentation{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    
    title String
    content String @db.Text
    docType DocumentationType
    filePath String? // Associated source file
    
    // Versioning
    version String @default("1.0.0")
    status DocStatus @default(DRAFT)
    
    // AI generated metadata
    tags String[] // e.g., ["API", "Authentication", "REST"]
    estimatedReadTime Int // in minutes
    
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    sections DocumentationSection[]
}

model DocumentationSection{
    id         String   @id @default(cuid())
    order Int
    
    heading String
    content String @db.Text
    codeExamples Json? // Array of {language, code, description}
    
    documentationId String
    documentation Documentation @relation(fields: [documentationId], references: [id], onDelete: Cascade)
}

model APIEndpoint{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    
    method HTTPMethod
    path String
    description String @db.Text
    
    // Auto-extracted from code
    filePath String
    lineNumber Int
    
    // Parameters
    requestSchema Json? // JSON Schema
    responseSchema Json? // JSON Schema
    
    // Examples
    exampleRequest String? @db.Text
    exampleResponse String? @db.Text
    
    // Metadata
    authenticated Boolean @default(false)
    rateLimit String?
    deprecated Boolean @default(false)
    
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ArchitectureDiagram{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    
    title String
    description String @db.Text
    diagramType DiagramType
    
    // Mermaid or PlantUML syntax
    diagramCode String @db.Text
    
    // SVG or PNG rendered output
    renderedUrl String?
    
    projectId String
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

enum DocumentationType{
    API_REFERENCE
    ARCHITECTURE
    ONBOARDING
    CHANGELOG
    TECHNICAL_SPEC
    USER_GUIDE
}

enum DocStatus{
    DRAFT
    REVIEW
    PUBLISHED
    ARCHIVED
}

enum HTTPMethod{
    GET
    POST
    PUT
    PATCH
    DELETE
    OPTIONS
    HEAD
}

enum DiagramType{
    ARCHITECTURE
    SEQUENCE
    CLASS
    ER_DIAGRAM
    FLOW_CHART
    COMPONENT
}

// ============================================
// TIER 1: ENHANCED MEETING FEATURES
// ============================================

model ActionItem{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    
    title String
    description String @db.Text
    priority Priority @default(MEDIUM)
    status TaskStatus @default(TODO)
    
    dueDate DateTime?
    completedAt DateTime?
    
    // Linked to code
    filePath String?
    lineNumber Int?
    
    // External integration
    jiraId String?
    linearId String?
    asanaId String?
    
    assigneeId String?
    assignee User? @relation("AssignedActionItems", fields: [assigneeId], references: [id], onDelete: SetNull)
    
    meetingId String
    meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
    
    reminders Reminder[]
}

model Reminder{
    id         String   @id @default(cuid())
    createdAt  DateTime @default(now())
    scheduledFor DateTime
    sent Boolean @default(false)
    sentAt DateTime?
    
    actionItemId String
    actionItem ActionItem @relation(fields: [actionItemId], references: [id], onDelete: Cascade)
}

enum Priority{
    CRITICAL
    HIGH
    MEDIUM
    LOW
}

enum TaskStatus{
    TODO
    IN_PROGRESS
    BLOCKED
    DONE
    CANCELLED
}